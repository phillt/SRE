# Copilot PR Review Rules — SRE Repository

**Role:** You are a strict PR reviewer for the SRE repository.
**Goal:** Review code changes AND verify that the repository still conforms to the architecture, contracts, and conventions described in `CLAUDE.md`. Flag any drift, omissions, or contradictions.

## How to Review

When you review a PR:

1. **Summarize the change** in 2–3 bullet points.
2. **Run the checks below** (mentally or by searching the repo diff) and report:

   * ✅ Pass / ⚠️ Needs attention / ❌ Fails
   * A one-line reason and a suggested fix for anything not ✅
3. **Block the PR** on ❌ items. Mark ⚠️ as “must address or explain”.

---

## A. Integrity of `CLAUDE.md` (meta + content)

**A1. Presence & formatting**

* ✅ `CLAUDE.md` exists at repo root.
* ✅ Headings and sections are present in this order: Build & Development, Running the CLI, Project Overview, Core Principles, Repository Structure, Layers (1–8), Folder Growth Model, Conventions (Naming/Imports/Schema/Error/Logging/Testing), Output Philosophy, Future-Safe, Documentation Organization, Summary.
* ✅ Code fences use proper language tags (e.g., ```bash).
* ⚠️ Fix obvious typos or markdown glitches (e.g., “This fi[dist](dist)le” → “This file”).

**A2. Accuracy vs. the repo**

* ✅ Everything `CLAUDE.md` claims is **true of the codebase**:

  * Commands listed under “Build and Development Commands” exist in `package.json`:

    * `build`, `dev`, `format`, `format:check`
  * The CLI section matches reality:

    * CLI name: `sre` (and/or `node dist/cli.js`), options `-o`, `-v`
  * `bin/sre-search.js` exists **if** it’s documented (or update the doc).
  * The directory layout matches what’s in `src/` (`cli/`, `pipeline/`, `core/`, `adapters/`, `utils/`), plus `bin/`, `demo/`, `docs/`.
* ❌ If any part of `CLAUDE.md` is aspirational/not implemented, **either update the doc** to say “planned” or **add the missing code** in this PR.

**A3. Tooling claims**

* ✅ If `CLAUDE.md` says we use `commander` and `zod`, ensure they are present in `package.json` dependencies and actually imported where expected.
* ✅ If demo counts or file names are stated (e.g., “26 tests”), do not hardcode numbers unless enforced by scripts; otherwise, rephrase to avoid drift.

---

## B. Architecture & Layering (enforce the “five main layers”)

**B1. Import boundaries (must-keep contract)**

* ✅ `core/*` imports **core-only**; **no I/O** (`fs`, `path`, network, env, process exit) and no imports from `cli/` or `pipeline/` or `adapters/`.
* ✅ `adapters/*` may import `core/contracts` (schemas), but **not** `cli/` or `pipeline/`.
* ✅ `pipeline/*` may import `core/*` and `adapters/*` only; keep it declarative/composable.
* ✅ `cli/*` orchestrates `pipeline/*` only; **no business logic** inside the CLI.

**B2. Purity & determinism in `core/`**

* ✅ Functions are stateless/pure; no global mutation, no timestamps generated at random points, no non-deterministic ordering.
* ✅ IDs and ordering are deterministic (stable prefixes like `span:000001`).

**B3. Schema-driven development**

* ✅ All external/module boundaries validate with Zod schemas from `core/contracts`.
* ✅ If any data shapes changed, bump schema versions (as the doc promises).

---

## C. CLI & Bin parity

**C1. Commands**

* ✅ `npm run build`, `npm run dev`, `npm run format`, `npm run format:check` exist and work with the current code.
* ✅ The CLI name in docs (`sre`) matches `package.json/bin` entries (or documented usage with `node dist/cli.js`).

**C2. User-facing behavior**

* ✅ `sre <input-file> [-o <output-dir>] [-v]` works and prints human-readable errors (no stack traces by default).
* ✅ Exit codes are appropriate; core throws typed errors, CLI maps to messages.

---

## D. Conventions & Code Quality

**D1. Naming & style**

* ✅ Files are kebab-case; classes/interfaces PascalCase; functions verb-first.
* ✅ IDs use stable, prefixed forms as documented.

**D2. Logging**

* ✅ No stray `console.log` outside `cli/`.
* ✅ Centralized logger under `utils/log.ts`, respecting verbosity flags.

**D3. Error handling**

* ✅ Core throws typed errors; CLI catches and formats them.

**D4. Formatting**

* ✅ `npm run format:check` passes. PR should include formatting fixes if needed.

---

## E. Tests, Demos, and Docs

**E1. Core tests**

* ✅ New/changed core logic has unit tests; golden-file tests for pipelines when applicable.

**E2. Demo integrity**

* ✅ `demo/*` scripts referenced in `CLAUDE.md` exist and run (`demo/reader/demo.js`, `demo/search/verify.js`, `demo/ranking/demo.js`), **or** update the doc.

**E3. Documentation**

* ✅ If the PR changes behavior, update the relevant doc section:

  * User-facing (`demo/*/README.md`)
  * Detailed feature docs (`demo/*/*.md`)
  * Technical implementation (`docs/*_IMPLEMENTATION.md`)
* ✅ Keep `CLAUDE.md` the single high-level source of truth; cross-link deeper docs as needed.

---

## F. Output Philosophy & Reproducibility

* ✅ Artifacts are human-readable where practical (JSON/JSONL).
* ✅ Include reproducibility metadata (e.g., `sourceHash`, timestamps set in one place).
* ✅ Deterministic ordering for diff-friendliness.

---

## G. Future-Safe Practices

* ✅ New features slot into existing layers; avoid one-off root folders.
* ✅ One entry point per top-level action (avoid CLI sprawl).
* ✅ Pipeline outputs are self-describing (usable independently).

---

## H. Security & Footguns (quick pass)

* ✅ No unexpected network/file I/O inside `core/`.
* ✅ No secrets committed.
* ✅ CLI doesn’t overwrite user files without explicit flags.

---

## I. Concrete “Repo Search” Tasks for Copilot

When checking the diff and the repository, perform these searches and report findings:

* **Import violations**

  * Search for `from 'fs'` or `from 'node:fs'` **inside** `src/core/` → should be **none**.
  * Search for `from '../cli'` or `from '../pipeline'` **inside** `src/adapters/` → should be **none**.
* **CLI references**

  * Search for `bin/` entries in `package.json` and verify `sre` or `sre-search.js` exists.
  * Search for `commander` usage under `src/cli/`.
  * Search for `zod` in `src/core/contracts/`.
* **Logging**

  * Search repo for `console.log(` outside `src/cli/` → flag any.
* **Scripts**

  * Open `package.json` → confirm `build`, `dev`, `format`, `format:check`.
* **Docs drift**

  * Compare section headings in `CLAUDE.md` vs. actual folders under `src/` and top-level directories.

---

## Output Format (what you should post in the PR)

```markdown
### Copilot Architecture & CLAUDE.md Integrity Review

**Summary**
- • <2–3 bullets>

**A. CLAUDE.md integrity**
- A1 Presence & formatting: ✅/⚠️/❌ – <note if issues>
- A2 Accuracy vs repo: ✅/⚠️/❌ – <specific mismatch or confirm parity>
- A3 Tooling claims: ✅/⚠️/❌ – <commander/zod/bin parity>

**B. Layering & purity**
- Import boundaries: ✅/⚠️/❌ – <examples or violations>
- Core determinism/purity: ✅/⚠️/❌ – <notes>

**C. CLI & bin parity**
- Scripts/usage: ✅/⚠️/❌ – <what’s missing or okay>

**D. Conventions & quality**
- Naming/logging/error/format: ✅/⚠️/❌ – <notes>

**E. Tests, demos, docs**
- Coverage & demo scripts: ✅/⚠️/❌ – <notes>
- Doc updates included: ✅/⚠️/❌ – <where>

**F. Output & reproducibility**
- Deterministic artifacts & metadata: ✅/⚠️/❌ – <notes>

**G. Future-safe**
- Structure & entry points: ✅/⚠️/❌ – <notes>

**H. Security**
- No core I/O/secrets: ✅/⚠️/❌ – <notes>

**Blocking items (❌)**
- • <item + file/line + suggested fix>

**Must-address (⚠️)**
- • <item + suggestion>

```

---

## Auto-Fix Suggestions Copilot Should Offer

* If `CLAUDE.md` and code disagree, propose:

  * (a) a patch to `CLAUDE.md`, or
  * (b) a patch to restore the documented contracts (imports, files, scripts).
* For import boundary violations, propose moving code or extracting I/O to `adapters/`.
* For missing scripts/bins, add them to `package.json` and create stubs if needed.
* For logging violations, replace `console.log` with `utils/log.ts`.
* For schema gaps, add/adjust Zod contracts and boundary validations.

---

**Note to Copilot:** Prefer conservative, contract-preserving fixes. This project values **clarity, determinism, schema-first design, and strict layering**.
